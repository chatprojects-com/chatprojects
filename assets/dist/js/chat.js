import{m as e}from"./vendor-markdown-C9lje_HT.js";import{H as t,t as a}from"./index-DWuNdYZ9.js";/* empty css             */import"./vendor-highlight-DerHs5y0.js";e.setOptions({highlight:function(e,a){return a&&t.getLanguage(a)?t.highlight(e,{language:a}).value:t.highlightAuto(e).value},breaks:!0,gfm:!0}),document.addEventListener("alpine:init",()=>{window.Alpine.data("chat",(t=null,s=null,r="project")=>({projectId:t,threadId:s,mode:r,provider:"openai",model:"gpt-4o",messages:[],input:"",loading:!1,streaming:!1,currentStreamingMessage:null,abortController:null,availableProviders:[],selectedProvider:null,selectedModel:null,currentChatProvider:null,currentChatModel:null,attachedImages:[],isDragOver:!1,isProUser:"undefined"!=typeof chatprData&&chatprData.is_pro_user||!1,maxImagesPerMessage:"undefined"!=typeof chatprData&&parseInt(chatprData.max_images_per_message)||1,async init(){this.threadId&&this.loadMessages(),"general"===this.mode&&await this.loadAvailableProviders(),window.addEventListener("vp:chat:new",()=>{this.startNewChat()}),window.addEventListener("vp:chat:switch",e=>{this.switchChat(e.detail.threadId)}),this.$watch("input",()=>{this.autoResizeTextarea()})},async loadMessages(){var e,t;if(chatprData.nonceReady){try{await chatprData.nonceReady}catch(e){}}this.loading=!0;try{const s="general"===this.mode?"chatpr_get_general_chat_history":"chatpr_load_chat_history";const r=await fetch(chatprData.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:s,nonce:chatprData.nonce,chat_id:this.threadId})});const i=await r.json();i.success?(this.messages=i.data.messages||i.data,this.scrollToBottom()):a((null==(t=i.data)?void 0:t.message)||"Failed to load messages","error")}catch(s){a("Failed to load messages","error")}finally{this.loading=!1}},async sendMessage(){const e=this.input.trim().length>0,t=this.attachedImages.length>0;if(!e&&!t||this.loading||this.streaming)return;const a=this.input.trim(),s=[...this.attachedImages];this.input="",this.attachedImages=[];const r={role:"user",content:a,timestamp:(new Date).toISOString()};s.length>0&&(r.images=s.map(e=>e.dataUrl)),this.messages.push(r),this.scrollToBottom(),await this.streamResponse(a,s)},async streamResponse(e,t=[]){var s;console.log("[ChatProjects] streamResponse called, mode:",this.mode);if(typeof chatprData==="undefined"||!chatprData.ajax_url||!chatprData.nonce){a("Session expired. Please refresh the page.","error");return}console.log("[ChatProjects] chatprData check passed");if(chatprData.nonceReady){console.log("[ChatProjects] Waiting for nonceReady...");try{await chatprData.nonceReady;console.log("[ChatProjects] nonceReady resolved")}catch(e){console.log("[ChatProjects] nonceReady error:",e)}}this.streaming=!0,this.abortController=new AbortController;const r={role:"assistant",content:"",timestamp:(new Date).toISOString(),streaming:!0,sources:[]};this.messages.push(r),this.currentStreamingMessage=r;try{if("general"===this.mode){console.log("[ChatProjects] Preparing general mode fetch...");const i={action:"chatpr_stream_general_message",nonce:chatprData.nonce,message:e,chat_id:this.threadId||"",provider:this.selectedProvider,model:this.selectedModel};console.log("[ChatProjects] Fetch params:",{action:i.action,provider:i.provider,model:i.model});t.length>0&&(i.images_base64=JSON.stringify(t.map(e=>({dataUrl:e.dataUrl,name:e.name,type:e.type}))));console.log("[ChatProjects] About to fetch...");const o=await fetch(chatprData.ajax_url,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(i),signal:this.abortController.signal});console.log("[ChatProjects] Fetch completed, status:",o.status);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const n=o.body.getReader(),d=new TextDecoder;let l="",h=!1;for(;!h;){const{done:e,value:t}=await n.read();if(e)break;l+=d.decode(t,{stream:!0});const s=l.split("\n");l=s.pop()||"";for(const o of s)if(o.trim()&&o.startsWith("data: ")){const e=o.slice(6);if("[DONE]"===e){h=!0;break}try{const t=JSON.parse(e);if("content"===t.type&&t.content){console.log("[ChatProjects] Received content chunk:",t.content.substring(0,50));r.content+=t.content;const idx=this.messages.findIndex(m=>m.streaming&&m.role==="assistant");if(idx!==-1){this.messages[idx]={...this.messages[idx],content:r.content};this.messages=[...this.messages]}this.scrollToBottom()}else if("chat_id"===t.type&&t.chat_id)this.threadId=t.chat_id,window.dispatchEvent(new CustomEvent("vp:chat:updated",{detail:{threadId:this.threadId}}));else if("error"===t.type)return a(t.content||"An error occurred","error"),void(this.messages=this.messages.filter(e=>e!==r));else if("done"===t.type){h=!0;break}}catch(c){}}}this.currentStreamingMessage=null;const c=this.messages.findIndex(m=>m.streaming&&m.role==="assistant");if(c!==-1){this.messages[c]={...this.messages[c],streaming:!1};this.messages=[...this.messages]}window.dispatchEvent(new CustomEvent("vp:chat:updated",{detail:{threadId:this.threadId}})),setTimeout(()=>{window.dispatchEvent(new CustomEvent("vp:chat:updated",{detail:{threadId:this.threadId}}))},2500)}else{const o=await fetch(chatprData.stream_url||chatprData.ajax_url,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"chatpr_stream_chat_message",nonce:chatprData.nonce,message:e,thread_id:this.threadId||"",project_id:this.projectId||""}),signal:this.abortController.signal});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const n=o.body.getReader(),d=new TextDecoder;let l="",h=!1;for(;!h;){const{done:e,value:t}=await n.read();if(e)break;l+=d.decode(t,{stream:!0});const s=l.split("\n");l=s.pop()||"";for(const o of s)if(o.trim()&&o.startsWith("data: ")){const e=o.slice(6);if("[DONE]"===e){h=!0;break}try{const t=JSON.parse(e);if("content"===t.type&&t.content){console.log("[ChatProjects] Received content chunk:",t.content.substring(0,50));r.content+=t.content;const idx=this.messages.findIndex(m=>m.streaming&&m.role==="assistant");if(idx!==-1){this.messages[idx]={...this.messages[idx],content:r.content};this.messages=[...this.messages]}this.scrollToBottom()}else if("sources"===t.type&&t.sources)r.sources=t.sources;else if("chat_id"===t.type&&t.chat_id)this.threadId=t.chat_id;else{if("error"===t.type)return a(t.content||"An error occurred","error"),void(this.messages=this.messages.filter(e=>e!==r));if("done"===t.type){h=!0;break}}}catch(i){}}}this.currentStreamingMessage=null;const c=this.messages.findIndex(m=>m.streaming&&m.role==="assistant");if(c!==-1){this.messages[c]={...this.messages[c],streaming:!1};this.messages=[...this.messages]}window.dispatchEvent(new CustomEvent("vp:chat:updated",{detail:{threadId:this.threadId}})),setTimeout(()=>{window.dispatchEvent(new CustomEvent("vp:chat:updated",{detail:{threadId:this.threadId}}))},2500)}}catch(o){if("AbortError"!==o.name){console.error("[ChatProjects] Stream error:",o);console.error("[ChatProjects] Error name:",o.name,"message:",o.message);console.error("[ChatProjects] chatprData state:",{ajax_url:chatprData?.ajax_url,nonce:chatprData?.nonce?.substring(0,8)+"...",nonceReady:!!chatprData?.nonceReady});const msg=o.message&&o.message.includes("status")?"Server error: "+o.message:"Failed to get response: "+(o.message||o.name||"unknown error");a(msg,"error");this.messages=this.messages.filter(e=>e!==r)}}finally{this.streaming=!1;const idx=this.messages.findIndex(m=>m.streaming&&m.role==="assistant");if(idx!==-1){this.messages[idx]={...this.messages[idx],streaming:!1};this.messages=[...this.messages]}this.abortController=null}},stopGeneration(){if(this.abortController){this.abortController.abort();this.streaming=!1;const idx=this.messages.findIndex(m=>m.streaming&&m.role==="assistant");if(idx!==-1){this.messages[idx]={...this.messages[idx],streaming:!1};this.messages=[...this.messages]}this.currentStreamingMessage=null;a("Generation stopped","info",3e3)}},async regenerateResponse(){if(this.messages.length<2)return;this.messages.pop();const e=[...this.messages].reverse().find(e=>"user"===e.role);e&&await this.streamResponse(e.content)},renderMarkdown:t=>e.parse(t),copyMessage(e){navigator.clipboard.writeText(e).then(()=>{a("Copied to clipboard","success",2e3)})},startNewChat(){this.threadId=null,this.messages=[],this.input="","general"===this.mode&&(this.currentChatProvider=null,this.currentChatModel=null)},async switchChat(e){this.threadId=e,this.messages=[],await this.loadMessages(),"general"===this.mode&&await this.loadChatMetadata()},autoResizeTextarea(){this.$nextTick(()=>{const e=this.$refs.messageInput;e&&(e.style.height="auto",e.style.height=Math.min(e.scrollHeight,200)+"px")})},scrollToBottom(){this.$nextTick(()=>{const e=this.$refs.messagesContainer;e&&(e.scrollTop=e.scrollHeight)})},handleKeydown(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())},handleInputFocus(){if(window.innerWidth<768){document.body.classList.add("vp-keyboard-open");const e=this.$refs.messageInput;e&&setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"center"}),this.scrollToBottom()},300)}},handleInputBlur(){document.body.classList.remove("vp-keyboard-open")},async loadAvailableProviders(){if(chatprData.nonceReady){try{await chatprData.nonceReady}catch(x){}}try{const e=await fetch(chatprData.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"chatpr_get_available_providers",nonce:chatprData.nonce})}),t=await e.json();if(t.success&&(this.availableProviders=Object.entries(t.data.providers).map(([e,t])=>({id:e,name:t.name,models:t.models})),this.availableProviders.length>0)){const e=chatprData.default_provider||this.availableProviders[0].id,t=this.availableProviders.find(t=>t.id===e);this.selectedProvider=t?e:this.availableProviders[0].id;const a=this.availableProviders.find(e=>e.id===this.selectedProvider);if(a){const e=chatprData.default_model||a.models[0];this.selectedModel=a.models.includes(e)?e:a.models[0]}}}catch(e){a("Failed to load AI providers","error")}},get currentProviderModels(){const e=this.availableProviders.find(e=>e.id===this.selectedProvider);return e?e.models:[]},async handleProviderChange(){const e=this.availableProviders.find(e=>e.id===this.selectedProvider);e&&e.models.length>0&&(this.selectedModel=e.models[0]),this.threadId&&this.messages.length>0&&await this.confirmProviderSwitch()},async handleModelChange(){this.threadId&&this.messages.length>0&&await this.confirmProviderSwitch()},async confirmProviderSwitch(){var e;const t=this.currentChatProvider||this.selectedProvider,a=this.currentChatModel||this.selectedModel;if(t===this.selectedProvider&&a===this.selectedModel)return;const s=null==(e=this.availableProviders.find(e=>e.id===this.selectedProvider))?void 0:e.name;confirm(`Switching to ${s} (${this.selectedModel}) will create a new conversation. Your current chat history will be preserved in the sidebar.\n\nContinue?`)?await this.createNewChatWithProvider():(this.selectedProvider=t,this.selectedModel=a)},async createNewChatWithProvider(){var e;try{const t=await fetch(chatprData.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"chatpr_create_general_chat",nonce:chatprData.nonce,provider:this.selectedProvider,model:this.selectedModel})}),s=await t.json();s.success?(this.threadId=s.data.chat_id,this.messages=[],this.currentChatProvider=this.selectedProvider,this.currentChatModel=this.selectedModel,window.dispatchEvent(new CustomEvent("vp:chat:updated",{detail:{threadId:this.threadId}})),a("New conversation created","success",2e3)):a((null==(e=s.data)?void 0:e.message)||"Failed to create conversation","error")}catch(t){a("Failed to create new conversation","error")}},async loadChatMetadata(){try{const e=await fetch(chatprData.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"chatpr_get_chat_metadata",nonce:chatprData.nonce,chat_id:this.threadId})}),t=await e.json();t.success&&(this.currentChatProvider=t.data.provider,this.currentChatModel=t.data.model,this.selectedProvider=t.data.provider,this.selectedModel=t.data.model)}catch(e){}},async handleImageSelect(e){if("general"!==this.mode)return;const t=Array.from(e.target.files);await this.addImages(t),e.target.value=""},async handlePaste(e){var t;if("general"!==this.mode)return;const a=null==(t=e.clipboardData)?void 0:t.items;if(!a)return;const s=[];for(let r=0;r<a.length;r++)if(a[r].type.startsWith("image/")){const e=a[r].getAsFile();e&&s.push(e)}s.length>0&&(e.preventDefault(),await this.addImages(s))},async handleDrop(e){if("general"!==this.mode)return;this.isDragOver=!1;const t=Array.from(e.dataTransfer.files).filter(e=>e.type.startsWith("image/"));t.length>0&&await this.addImages(t)},async addImages(e){var t,s,r,i;const o=-1===this.maxImagesPerMessage?1/0:this.maxImagesPerMessage-this.attachedImages.length;if(o<=0)return void a((null==(t=chatprData.i18n)?void 0:t.maxImagesReached)||"Maximum images reached","warning");const n=e.slice(0,o);for(const l of n){if(!["image/jpeg","image/png","image/gif","image/webp"].includes(l.type)){a((null==(s=chatprData.i18n)?void 0:s.invalidImageType)||"Invalid image type. Allowed: JPEG, PNG, GIF, WebP.","error");continue}const e=chatprData.max_image_size||10485760;if(l.size>e){const t=Math.round(e/1048576);a(((null==(r=chatprData.i18n)?void 0:r.imageTooLarge)||"Image exceeds {size} MB limit").replace("{size}",t),"error");continue}try{const e=await this.fileToDataUrl(l);this.attachedImages.push({name:l.name,type:l.type,size:l.size,dataUrl:e})}catch(d){a((null==(i=chatprData.i18n)?void 0:i.imageProcessError)||"Failed to process image","error")}}},fileToDataUrl:e=>new Promise((t,a)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=()=>a(new Error("Failed to read file")),s.readAsDataURL(e)}),removeImage(e){this.attachedImages.splice(e,1)},openImageModal(e){window.open(e,"_blank")}}))});
